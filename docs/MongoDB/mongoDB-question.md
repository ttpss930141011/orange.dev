---
sidebar_position: 1
---
# 常見問題

# 為什麼mongodb這麼佔記憶體？

MongoDB 會佔用較多的記憶體主要是因為它使用了**內存導向的資料庫引擎**，可以將資料載入到記憶體中來提升查詢速度。如果記憶體不足，MongoDB 將會使用操作系統的交換空間來存放資料，這樣就會對系統性能造成影響。
另外,若資料量龐大,需要更多的記憶體來儲存資料.
如果您只是在開發或測試環境中使用 MongoDB，您可能需要限制記憶體使用量。

# 要怎麼限制記憶體使用量?

MongoDB 預設會使用所有可用的記憶體。要限制記憶體使用量，您可以使用以下兩種方法之一:

1. 使用 --wiredTigerCacheSizeGB 選項，將 WiredTiger 緩衝區的大小設置為特定值。例如，設置為 2GB 的緩衝區大小:
**`mongod --wiredTigerCacheSizeGB 2`**
2. 使用 --maxConns 選項，限制 MongoDB 的最大連接數。這樣可以限制 MongoDB 可以使用的記憶體量，因為較少的連接需要較少的內存。

這些選項在 mongod.conf 檔案中設置也可以

還有一些記憶體使用上的優化方式，如使用較小的文件尺寸、設置合理的記憶體剖面、使用更低的 journal 剖面等等。

# 甚麼是記憶體剖面和 journal 剖面?

記憶體剖面 (Memory Profiler) 是一種分析軟體，用於測量程序中的記憶體使用情況。它可以檢查程序中的記憶體泄漏，顯示目前的記憶體使用量，並提供有關程序中特定時間點的記憶體使用情況的詳細資訊。

journal 剖面 (Journal Profiler) 是 MongoDB 的一項功能，可以記錄並分析每個請求進入資料庫時的執行時間和記憶體使用量。這可以幫助您了解系統的資源使用情況，並尋找性能瓶頸。

# mongoose 可以使用Journal Profiler嗎？

Mongoose是一個MongoDB的Object Document Mapping(ODM)庫，它可以讓開發者使用JavaScript對MongoDB進行操作。Mongoose本身並不支援Journal Profiler，但是它可以通過使用MongoDB原生的JavaScript API來使用Journal Profiler。使用Mongoose可以在JavaScript中更方便地操作MongoDB，但它本身不支援所有MongoDB的功能。如果需要使用Journal Profiler，可以考慮使用MongoDB原生的JavaScript API。

# 可以示範一下如何使用MongoDB原生的JavaScript API來實現Journal Profiler嗎?

MongoDB的原生JavaScript API可以透過設定**`profilingLevel`**來啟用Journal Profiler。

首先，你需要在MongoDB中啟用profiling，可以透過在命令列中執行以下指令來啟用：

```bash
use mydb
db.setProfilingLevel(2)
```

接下來，你可以使用**`db.system.profile`**集合來查詢Journal Profiler的結果。例如，你可以執行以下指令來查詢最近的100筆Journal Profiler結果：

```bash
db.system.profile.find().limit(100)
```

若要關閉profiling，可以透過執行以下指令：

```bash
db.setProfilingLevel(0)
```

請注意,這些指令要在mongo shell上執行。

# 那我經由分析Journal Profiler，我該如何enhance資料庫？

分析Journal Profiler可以幫助你找出效能瓶頸和需要優化的部分。

- 增加索引: 檢查Journal Profiler中較慢的查詢是否有不足的索引。
- 優化查詢: 檢查查詢是否有不必要的欄位或條件。
- 調整記憶體設定: 檢查是否需要調整MongoDB的記憶體設定，例如cacheSizeGB或wiredTigerCacheSizeGB。
- 調整剖面設定: 檢查是否需要調整Journal剖面的設定，例如commitIntervalMs或journalCompressor。
- 優化資料模型: 檢查是否需要更改資料模型以減少資料庫的負擔。
- 分片：如果您的數據量非常大且效能不足，您可能需要將數據分片到多個分片上。

需要提醒的是, 效能優化通常是一個迭代的過程, 需要不斷評估和測試.

# Mongodb會默認占用所有可用的記憶體，但是當其他程式需要記憶體空間的時候該怎麼辦？

當其他程式需要記憶體空間的時候，MongoDB會根據系統的需要自動釋放記憶體。另外，您可以在MongoDB的配置文件中設置最大記憶體使用量限制，以防止MongoDB對系統的記憶體使用量過大。另外，MongoDB使用的是虛擬記憶體，當系統缺少記憶體時，它會將資料寫入硬碟，以避免系統停頓。

# 他佔用的是實體記憶體，怎麼會說是使用虛擬記憶體呢？

MongoDB 在運行時會使用實體記憶體，但也可能使用虛擬記憶體。 虛擬記憶體是指操作系統對於物理記憶體的一種抽象，它可以讓程式像使用實體記憶體一樣使用記憶體，而不用擔心實體記憶體的限制。當程式需要更多的記憶體，而實體記憶體不足時，操作系統可以使用虛擬記憶體來解決這個問題。MongoDB 也會使用這種機制，它可以在需要時使用虛擬記憶體來存儲資料，而不需要等待實體記憶體空間。

# 虛擬記憶體是指操作系統對於物理記憶體的一種抽象，可以再更深入說明這句話嗎？

虛擬記憶體是指操作系統將物理記憶體擴展到硬碟上的一種技術。在實際運行時，每個程式都會被操作系統分配一定的記憶體空間來執行，而記憶體實際上只有物理記憶體那麼多，所以當記憶體不足時，操作系統會將一部分不常使用的記憶體頁面（也稱為頁面交換）存儲到硬碟上，當需要訪問這些記憶體頁面時，操作系統就會將它們從硬碟讀取到記憶體中。這樣，每個程式都有足夠的記憶體空間來運行，即使實際上物理記憶體不足。

# 當物理記憶體不足時，mongodb會直接被停用

當物理記憶體不足時，操作系統會使用虛擬記憶體來補足實體記憶體的不足。當虛擬記憶體也不足時，操作系統會暫停一些程式的運行，以便給其他程式更多的記憶體。MongoDB 就是其中之一。當 MongoDB 在缺少物理記憶體的情況下運行時，它會使用虛擬記憶體。但是當系統虛擬記憶體用盡時，MongoDB 仍然無法運行，因為沒有足夠的記憶體可供它使用。所以,在實際運行Mongodb時,要注意物理記憶體的使用量,以避免系統因為記憶體不足而停止運作.

# MongoDB使用的是虛擬記憶體較多，還是實體記憶體較多？

MongoDB會使用實體記憶體較多。當MongoDB運行時，它會將數據讀入到實體記憶體中，以便能夠快速存取。如果實體記憶體不足，MongoDB可能會使用虛擬記憶體，但這樣會使性能降低。因此在設置MongoDB時，應該確保有足夠的實體記憶體可供其使用。

# 一般的RDBMS查詢速度沒Mongodb快是因為沒有使用到實體記憶體的關係嗎？

RDBMS（關聯式資料庫管理系統）的查詢速度比Mongodb慢並不是因為沒有使用到實體記憶體，而是因為RDBMS和Mongodb的設計理念和儲存方式不同。

RDBMS使用關聯式資料庫模型，將資料存儲在多個表格中，查詢時需要進行聯集、交集、限制等運算，速度較慢。而Mongodb使用文件型資料庫模型，將資料存儲在文件中，查詢時可以直接讀取文件，速度較快。

另外，RDBMS還有一些限制，例如資料型別限制、索引限制等，這些限制也會影響查詢速度。而Mongodb沒有這些限制，所以具有較高的查詢效率。

因此，RDBMS和Mongodb在查詢速度上並沒有明顯的差異，而是有各自的優缺點。RDBMS使用關聯式資料庫模型，通常會更適合需要多表關聯性資料或高交易處理性能的應用程式。而Mongodb使用文件儲存和非關聯式模型，更適合存儲非結構化資料或需要高吞吐量的應用程式。

# 那RDBMS是不是就不會把資料載入實體記憶體以提升查詢速度了?

RDBMS也可以將資料載入實體記憶體中以提升查詢速度，這是為了減少磁碟存取次數以提升效能。這種技術被稱為資料快取，通常由資料庫管理系統（DBMS）自動實現。MongoDB也有一個名為「記憶體剖面」的功能，可以將資料載入實體記憶體中以提升查詢速度。

# RDBMS的資料快取占用的空間是否會比較多，因為資料之間需要關聯性，所以要把各種表載入實體記憶體？

RDBMS通常會使用資料快取來提升查詢速度，而資料快取主要是將常用的資料載入實體記憶體，以便快速存取。由於RDBMS會進行資料關聯，因此可能會將多個表的資料載入實體記憶體，這可能會使得資料快取占用的空間較大。不過，實際上會因為資料量，系統配置以及快取策略等因素而有所不同。