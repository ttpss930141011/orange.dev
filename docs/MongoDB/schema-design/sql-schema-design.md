---
sidebar_position: 2
---
# SQL schema design

# SQL schema design — 正規化地獄的開始


## **為何要執行正規化？**

1. 提昇儲存資料與資料庫操作效率
2. 減少資料異常
3. 使資料庫維護更容易

## **正規化的資料庫特性**

經過正規化後的資料庫，應具備以下特性：

1. 欄位唯一性：每個欄位只儲存一項資料
2. 主關鍵欄位：每筆資料都擁有一個主鍵，來區別這些資料
3. 功能關聯性：欄位之間的關聯應該要明確
4. 欄位獨立性：欄位之間不應存在遞移相依

# Example：


Comsumptions table

| 姓名 | 性別 | gender | 項目 | 價格 | 數量 | 商店 | 地址 | 日期 | 訂單編號 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 阿寶 | 女 | F | 鉛筆、橡皮擦 | 20, 50 | 1,2 | 久成久 | 東區大學路 | 12/17 | 1 |
| 豆芽 | 女 | F | 牛奶、三明治 | 70, 10 | 2,1 | 全家 | 東區北門路 | 12/18 | 2 |
| 豆芽 | 女 | F | 牛奶、三明治 | 70, 10 | 3,4 | 全家 | 東區北門路 | 12/19 | 3 |
| 老皮 | 男 | M | 蛋餅、奶茶 | 30, 40 | 1,2 | 日蝕 | 東區成功路 | 12/19 | 4 |

有幾個大問題存在於這張表中：

1. 在`項目`和`價格`這兩個columns裡面都出現了一個欄位儲存兩項以上的資料的問題。
2. `性別`和`gender`這兩個column，他們在意義上是重複的。
3. 這些資料並沒有一個primary key可以辨識他們的區別，這些欄位都有可能是重複的。

## **第一正規化**

第一NF要完成的工作：

1. 一個欄位只能有單一值
2. 消除意義上重複的欄位
3. 決定主鍵

comsumptions

| 姓名 | 性別 | 項目 | 價格 | 數量 | 總金額 | 商店 | 地址 | 日期 | 訂單編號 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 阿寶 | 女 | 鉛筆 | 20 | 1 | 20 | 久成久 | 東區大學路 | 12/17 | 1 |
| 阿寶 | 女 | 橡皮擦 | 50 | 2 | 100 | 久成久 | 東區大學路 | 12/17 | 1 |
| 豆芽 | 女 | 牛奶 | 70 | 3 | 210 | 全家 | 東區北門路 | 12/18 | 2 |
| 豆芽 | 女 | 三明治 | 10 | 1 | 10 | 全家 | 東區北門路 | 12/18 | 2 |
| 豆芽 | 女 | 牛奶 | 70 | 3 | 210 | 全家 | 東區北門路 | 12/19 | 3 |
| 豆芽 | 女 | 三明治 | 10 | 4 | 40 | 全家 | 東區北門路 | 12/19 | 3 |
| 老皮 | 男 | 蛋餅 | 30 | 1 | 30 | 日蝕 | 東區成功路 | 12/19 | 4 |
| 老皮 | 男 | 奶茶 | 40 | 2 | 80 | 日蝕 | 東區成功路 | 12/19 | 4 |

這張表還是存在著一些問題：

每一筆消費紀錄都要紀錄消費者的性別、商店的名稱和地址，重複內容過多。

## **第二正規化**

第二NF要完成的工作：

1. 消除部分相依

<aside>
💡 部分相依的意思為跟主鍵只有一部份有關係，另一部份沒有關係的欄位，我們要把這些欄位獨立於另一張表。

</aside>

consumers

| id | 姓名 | 性別 |
| --- | --- | --- |
| 2 | 阿寶 | 女 |
| 3 | 豆芽 | 女 |
| 4 | 老皮 | 男 |

shops

| id | 商店 | 地址 |
| --- | --- | --- |
| 1 | 久成久 | 東區大學路 |
| 2 | 全家 | 東區北門路 |
| 3 | 日蝕 | 東區成功路 |

items

| id | 項目 | 價格 | 商店id |
| --- | --- | --- | --- |
| 1 | 鉛筆 | 20 | 1 |
| 2 | 橡皮擦 | 50 | 1 |
| 3 | 牛奶 | 70 | 2 |
| 4 | 三明治 | 10 | 2 |
| 5 | 蛋餅 | 30 | 3 |
| 6 | 奶茶 | 40 | 3 |

orders

| id | 消費者id | 商品id | 數量 | 總金額 | 日期 | 訂單編號 |
| --- | --- | --- | --- | --- | --- | --- |
| 1 | 1 | 1 | 1 | 20 | 12/17 | 1 |
| 2 | 1 | 2 | 2 | 100 | 12/17 | 1 |
| 3 | 2 | 3 | 3 | 210 | 12/18 | 2 |
| 4 | 2 | 4 | 1 | 10 | 12/18 | 2 |
| 5 | 2 | 3 | 3 | 210 | 12/19 | 3 |
| 6 | 3 | 4 | 4 | 40 | 12/19 | 3 |
| 7 | 3 | 5 | 1 | 30 | 12/19 | 4 |
| 8 | 3 | 6 | 2 | 80 | 12/19 | 4 |

然而，這樣還是會有一個問題，就是`遞移關係`。

<aside>
💡 所謂遞移關係，在這個範例裡就是指：總金額是依賴商品及數量的資訊，而商品id和數量又和主鍵直接相關，那總金額和主鍵之間的關係就是遞移關係。

用個比較容易理解的方式來說明：為了避免數量改變而總金額沒改到造成資料錯誤，應該把總金額那個欄位移除。

</aside>

## **第三正規化**

在第三正規化的規範中，要消除資料表中與主欄位的遞移相依

第三NF要完成的工作：

1. 消除資料表中的遞移相依

<aside>
💡 消除遞移相依：非主鍵屬性的欄位都只能和候選鍵相關，非主鍵屬性的欄位彼此間應該要是獨立無關的

</aside>

> 遞移相依：欄位1和主鍵相關，欄位2和欄位1相關，欄位2和主鍵就是地移相依
> 

> 候選鍵：欄位組合讓資料能是唯一的，並且是最小唯一
> 

consumers

| id | 姓名 | 性別 |
| --- | --- | --- |
| 1 | 阿寶 | 女 |
| 2 | 豆芽 | 女 |
| 3 | 老皮 | 男 |

shops

| id | 商店 | 地址 |
| --- | --- | --- |
| 1 | 久成久 | 東區大學路 |
| 2 | 全家 | 東區北門路 |
| 3 | 日蝕 | 東區成功路 |

items

| id | 項目 | 價格 | 商店id |
| --- | --- | --- | --- |
| 1 | 鉛筆 | 20 | 1 |
| 2 | 橡皮擦 | 50 | 1 |
| 3 | 牛奶 | 70 | 2 |
| 4 | 三明治 | 10 | 2 |
| 5 | 蛋餅 | 30 | 3 |
| 6 | 奶茶 | 40 | 3 |

orders

| id | 消費者id | 單價 | 數量 | 商品id | 日期 | 訂單編號 |
| --- | --- | --- | --- | --- | --- | --- |
| 1 | 1 | 20 | 1 | 1 | 12/17 | 1 |
| 2 | 1 | 50 | 2 | 2 | 12/17 | 1 |
| 3 | 2 | 70 | 3 | 3 | 12/18 | 2 |
| 4 | 2 | 10 | 1 | 4 | 12/18 | 2 |
| 5 | 2 | 70 | 3 | 3 | 12/19 | 3 |
| 6 | 3 | 10 | 4 | 4 | 12/19 | 3 |
| 7 | 3 | 30 | 1 | 5 | 12/19 | 4 |
| 8 | 3 | 40 | 2 | 6 | 12/19 | 4 |

## **BUT**

但是，並不是每次建表都要照著正規化的規範才是最好的。

像前面這個範例，假如我的資料量不大，但我的業務需求是要反覆的去查詢某個消費者買的什麼商品，是在什麼地方的資料。

例如，我想找到今天豆芽買牛奶的地址，我必須先從consumptions關聯到items，再關聯到shops。

![https://i.imgur.com/s0N4U0x.png](https://i.imgur.com/s0N4U0x.png)

這樣似乎反而比第二正規化前更缺乏效率。

# **結論**

---

因此，資料庫正規化要進行到什麼程度，應視對資料庫操作的需求和資料量而定，而不是每次建表都只要無腦的全部照著正規化的規範去設計你的表格就好。